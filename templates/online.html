{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SereneMind | Mental Health Support</title>
    <link rel="stylesheet" href="{% static 'css/web.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Group card styles */
        .group-card {
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid #6a8caf;
            padding: 20px;
            margin-bottom: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        
        .group-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow: auto;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            width: 80%;
            max-width: 800px;
            max-height: 90vh;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            padding: 15px;
            cursor: move;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .close-btn {
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }
        
        /* Video call interface */
        .video-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        @media (min-width: 768px) {
            .video-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .video-participant {
            position: relative;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 4/3;
        }
        
        .video-participant.doctor {
            border: 3px solid #4CAF50;
        }
        
        .video-participant video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .participant-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 8px;
            display: flex;
            align-items: center;
        }
        
        .participant-status {
            margin-left: auto;
            display: flex;
            gap: 10px;
        }
        
        .status-icon {
            font-size: 14px;
        }
        
        .muted .fa-microphone {
            color: #ff5252;
        }
        
        .video-off .fa-video {
            color: #ff5252;
        }
        
        .waiting-room {
            text-align: center;
            padding: 40px 20px;
            background: #f5f5f5;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .waiting-icon {
            font-size: 50px;
            color: #6a8caf;
            margin-bottom: 20px;
        }
        
        .permission-box {
            text-align: center;
            padding: 30px;
            background: #f5f5f5;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .permission-icon {
            font-size: 50px;
            color: #6a8caf;
            margin-bottom: 20px;
        }
        
        .permission-btn {
            background: #6a8caf;
            color: white;
            border: none;
            border-radius: 25px;
            padding: 12px 25px;
            margin: 15px 0;
            cursor: pointer;
            font-size: 16px;
        }
        
        .permission-btn:hover {
            background: #5a7c9f;
        }
        
        .camera-off {
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }
        
        .video-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }
        
        .video-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: #6a8caf;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .video-btn.end-call {
            background: #e74c3c;
        }
        
        /* Chat interface styles */
        .doctor-badge {
            background: #f0f7ff;
            padding: 10px 15px;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .chat-container {
            height: 200px;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            overflow-y: auto;
            background: #f9f9f9;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 70%;
            word-wrap: break-word;
        }
        
        .user-message {
            background: #e3f2fd;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }
        
        .other-message {
            background: #f1f1f1;
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }
        
        .doctor-message {
            background: #e8f5e9;
            border-left: 3px solid #4caf50;
        }
        
        .message-input {
            display: flex;
            margin-top: 15px;
        }
        
        .message-input input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 25px;
            outline: none;
        }
        
        .message-input button {
            background: #6a8caf;
            color: white;
            border: none;
            border-radius: 25px;
            padding: 0 20px;
            margin-left: 10px;
            cursor: pointer;
        }
        
        .supervisor-info {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        
        .supervisor-info img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
        }
        
        .status-message {
            color: green;
            text-align: center;
            margin: 10px 0;
            display: none;
        }
        
        .tab-container {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            border-bottom-color: #6a8caf;
            font-weight: 500;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav>
        <div class="logo">Serene<span>Mind</span></div>
        <ul class="nav-links">
            <li><a href="{% url 'te' %}">Home</a></li>
            <li><a href="{% url 'res' %}">Resources</a></li>
            <li><a href="{% url 'about' %}">About Us</a></li>
            <li><a href="{% url 'contact' %}" class="btn-contact">Contact</a></li>
        </ul>
        <div class="burger">
            <div class="line1"></div>
            <div class="line2"></div>
            <div class="line3"></div>
        </div>
    </nav>

    <div class="service-page">
        <div class="service-hero" style="background: linear-gradient(rgba(106, 140, 175, 0.9), rgba(154, 122, 160, 0.9)), url('https://images.unsplash.com/photo-1581093450025-4c8111a8366b?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1000&q=80');">
            <div class="container">
                <h1>Online Support Groups</h1>
                <p>Find community and understanding</p>
            </div>
        </div>
        
        <div class="service-content" style="margin-left:70px;">
            <div class="container">
                <div class="service-details">
                    <h2>Join Our Supportive Community</h2>
                    <p>Connect with others who share similar experiences in a safe, moderated environment.</p>
                    
                    <div class="group-types">
                        <div class="group-card" onclick="openGroupModal('anxiety')">
                            <h3><i class="fas fa-users"></i> Anxiety & Depression</h3>
                            <p>Weekly meetings for those managing mood disorders</p>
                            <span>Every Tuesday, 6-7:30pm</span>
                            <div class="btn-outline">Join Group</div>
                        </div>
                        <div class="group-card" onclick="openGroupModal('grief')">
                            <h3><i class="fas fa-heart"></i> Grief & Loss</h3>
                            <p>Support for those coping with bereavement</p>
                            <span>Every Thursday, 5-6:30pm</span>
                            <div class="btn-outline">Join Group</div>
                        </div>
                        <div class="group-card" onclick="openGroupModal('parenting')">
                            <h3><i class="fas fa-child"></i> Parenting Support</h3>
                            <p>For parents navigating mental health challenges</p>
                            <span>Every Saturday, 10-11:30am</span>
                            <div class="btn-outline">Join Group</div>
                        </div>
                    </div>
                    
                    <div class="testimonials">
                        <h3>What Members Say</h3>
                        <div class="testimonial">
                            <p>"Finding this group helped me realize I wasn't alone in my struggles."</p>
                            <span>- Sarah, group member since 2022</span>
                        </div>
                    </div>
                    
                    <a href="{% url 'groups' %}" class="btn-primary" style="margin-top:20px;">View All Groups</a>
                </div>
                
                <div class="service-image" style="margin-right:70px;">
                    <img src="/static/img/b1 (21).jpg" alt="Support group meeting">
                </div>
            </div>
        </div>
    </div>

    <!-- Group Session Modal -->
    <div id="groupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalGroupTitle">Support Group</h2>
                <span class="close-btn" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="doctor-badge">
                    <i class="fas fa-user-md"></i>
                    <span>Supervised by <strong id="modalDoctorName">Dr. Specialist</strong>, Clinical Psychologist</span>
                </div>
                
                <div class="supervisor-info">
                    <img id="doctorImage" src="" alt="Doctor">
                    <div>
                        <h4 id="modalDoctorFullName">Dr. Full Name</h4>
                        <p id="doctorSpecialty">Specialty information</p>
                    </div>
                </div>
                
                <p id="modalGroupDescription">Group description will appear here.</p>
                
                <div id="statusMessage" class="status-message"></div>
                
                <div id="registrationForm">
                    <h3>Join This Group</h3>
                    <form id="groupRegistrationForm">
                        <div style="margin: 15px 0;">
                            <label for="userName">Your Name</label>
                            <input type="text" id="userName" required style="width: 100%; padding: 10px; margin-top: 5px;">
                        </div>
                        <div style="margin: 15px 0;">
                            <label for="userEmail">Email Address</label>
                            <input type="email" id="userEmail" required style="width: 100%; padding: 10px; margin-top: 5px;">
                        </div>
                        <div style="margin: 15px 0;">
                            <label>
                                <input type="checkbox" id="agreeTerms" required> 
                                I agree to the <a href="#">group guidelines</a> and <a href="#">privacy policy</a>
                            </label>
                        </div>
                        <div style="margin: 15px 0;">
                            <label>
                                <input type="checkbox" id="anonymousOption"> 
                                Participate anonymously (your name won't be visible to others)
                            </label>
                        </div>
                        <button type="button" onclick="registerForGroup()" class="btn-primary" style="width: 100%; padding: 12px;">Join Group Session</button>
                    </form>
                </div>
                
                <div id="sessionInterface" style="display: none;">
                    <div class="tab-container">
                        <div class="tab active" onclick="switchTab('chat')">Group Chat</div>
                        <div class="tab" onclick="switchTab('video')">Video Call</div>
                    </div>
                    
                    <div id="chatTab" class="tab-content active">
                        <div class="doctor-badge">
                            <i class="fas fa-user-md"></i>
                            <span>Supervised by <strong id="chatDoctorName">Dr. Specialist</strong></span>
                        </div>
                        
                        <div class="chat-container" id="groupChat">
                            <div class="message doctor-message">
                                <strong>Group Facilitator:</strong> Welcome to the group! The session will begin shortly.
                            </div>
                        </div>
                        
                        <div class="message-input">
                            <input type="text" id="chatMessage" placeholder="Type your message..." onkeypress="if(event.keyCode==13) sendMessage()">
                            <button onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                    
                    <div id="videoTab" class="tab-content">
                        <div id="waitingRoom" class="waiting-room">
                            <div class="waiting-icon">
                                <i class="fas fa-user-clock"></i>
                            </div>
                            <h3 id="waitingMessage">Waiting for Doctor to Start Session</h3>
                            <p id="waitingDescription">The video session will begin when the doctor joins.</p>
                            <p id="participantCount">1 participant waiting (including you)</p>
                            
                            <div id="userPermissionRequest" class="permission-box" style="display: none;">
                                <div class="permission-icon">
                                    <i class="fas fa-video"></i>
                                </div>
                                <h3>Session Started!</h3>
                                <p>The doctor has started the session. Click below to join.</p>
                                <button onclick="joinUserVideoSession()" class="permission-btn">
                                    <i class="fas fa-camera"></i> Join Video Session
                                </button>
                            </div>
                        </div>

                        
                        
                        <div id="activeCall" style="display: none;">
                            <div class="video-grid" id="videoGrid">
                                <!-- Video participants will be added dynamically -->
                            </div>
                            
                            <div class="video-controls">
                                <button class="video-btn" onclick="toggleMute()">
                                    <i class="fas fa-microphone"></i>
                                </button>
                                <button class="video-btn" onclick="toggleVideo()">
                                    <i class="fas fa-video"></i>
                                </button>
                                <button class="video-btn end-call" onclick="endVideoCall()">
                                    <i class="fas fa-phone-slash"></i>
                                </button>
                            </div>
                            
                            <div class="doctor-controls" id="doctorControls" style="display: none;">
                                <div id="permissionRequest" class="permission-box">
                                    <div class="permission-icon">
                                        <i class="fas fa-video"></i>
                                    </div>
                                    <h3>Start Video Session</h3>
                                    <p>As the doctor, you need to enable your camera to start the session.</p>
                                    <button onclick="startDoctorVideoSession()" class="permission-btn">
                                        <i class="fas fa-camera"></i> Enable Camera & Start Session
                                    </button>
                                </div>
                                
                                <div id="doctorSessionControls" style="display: none;">
                                    <h4><i class="fas fa-user-md"></i> Doctor Controls</h4>
                                    <button onclick="muteAllParticipants()" class="btn-outline">
                                        <i class="fas fa-microphone-slash"></i> Mute All
                                    </button>
                                    <button onclick="endSessionForAll()" class="btn-outline">
                                        <i class="fas fa-sign-out-alt"></i> End Session for All
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <a href="http://127.0.0.1:8000/">click</a>

    <!-- Footer -->
    <footer>
        <div class="footer-content">
            <div class="footer-logo">Serene<span>Mind</span></div>
            <div class="footer-links">
                <a href="#">Privacy Policy</a>
                <a href="#">Terms of Service</a>
                <a href="#">Crisis Hotlines</a>
            </div>
            <div class="social-icons">
                <a href="#"><i class="fab fa-facebook"></i></a>
                <a href="#"><i class="fab fa-twitter"></i></a>
                <a href="#"><i class="fab fa-instagram"></i></a>
            </div>
        </div>
        <p>&copy; 2023 SereneMind. All rights reserved.</p>
    </footer>

    <script>
       // Server simulation for cross-browser communication
    const SERVER_URL = 'https://jsonplaceholder.typicode.com/posts'; // Using a mock API
    let sessionId = '';
    let pollIntervalId = null;
    const POLL_INTERVAL = 1000;
    let SESSION_STORAGE_KEY = '';
    let sessionBroadcastChannel = null;

    // Session states
    const SESSION_STATES = {
        WAITING: 'waiting',
        ACTIVE: 'active',
        ENDED: 'ended'
    };
        // Group data
        const groupsData = {
            'anxiety': {
                title: 'Anxiety & Depression Support Group',
                doctor: 'Dr. Sarah Johnson',
                doctorFull: 'Dr. Sarah Johnson',
                description: 'Weekly meetings for those managing mood disorders. Maximum 5 participants per session.',
                specialty: 'Specializes in cognitive behavioral therapy for anxiety disorders. 10 years experience.',
                doctorImage: 'https://images.unsplash.com/photo-1559839734-2b71ea197ec2?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=200&q=80',
                schedule: 'Every Tuesday, 6-7:30pm'
            },
            'grief': {
                title: 'Grief & Loss Support Group',
                doctor: 'Dr. Michael Chen',
                doctorFull: 'Dr. Michael Chen',
                description: 'Support for those coping with bereavement. Maximum 5 participants per session.',
                specialty: 'Specializes in grief counseling and trauma therapy. 8 years experience.',
                doctorImage: 'https://images.unsplash.com/photo-1594824476967-48c8b964273f?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=200&q=80',
                schedule: 'Every Thursday, 5-6:30pm'
            },
            'parenting': {
                title: 'Parenting Support Group',
                doctor: 'Dr. Emily Wilson',
                doctorFull: 'Dr. Emily Wilson',
                description: 'For parents navigating mental health challenges. Maximum 5 participants per session.',
                specialty: 'Specializes in family therapy and parental mental health. 12 years experience.',
                doctorImage: 'https://images.unsplash.com/photo-1573497019940-1c28c88b4f3e?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=200&q=80',
                schedule: 'Every Saturday, 10-11:30am'
            }
        };
    
        // Doctor emails
        const DOCTOR_EMAILS = [
            'roaa002.alibrahim@gmail.com'
        ].map(email => email.toLowerCase());
    
        // Current state
        let currentGroupId = '';
        let currentUser = {};
        let isDoctor = false;
        let localStream;
        let isMuted = false;
        let isVideoOff = false;
        let participants = [];
        let sessionActive = false;
    
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.group-card').forEach(card => {
                card.addEventListener('click', function() {
                    const groupId = this.getAttribute('data-group');
                    openGroupModal(groupId);
                });
            });
            
            makeDraggable(document.getElementById('groupModal'));
            
            // Initialize tabs - make sure chat tab is active by default
            switchTab('chat');
            
            // Add storage event listener for cross-tab communication
            window.addEventListener('storage', function(e) {
                if (e.key === SESSION_STORAGE_KEY) {
                    checkSessionState();
                }
            });
        });
    
        // Tab switching function
        function switchTab(tabName) {
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });
            
            // Activate selected tab
            const activeTab = document.querySelector(`.tab[data-tab="${tabName}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            // Show selected tab content
            const activeContent = document.getElementById(`${tabName}Tab`);
            if (activeContent) {
                activeContent.classList.add('active');
                activeContent.style.display = 'block';
            }
            
            // Initialize video call if switching to video tab and session is active
            if (tabName === 'video' && document.getElementById('sessionInterface').style.display === 'block') {
                initVideoCall();
            }
        }
    
        // Modal functions
        function makeDraggable(modal) {
            const header = modal.querySelector('.modal-header');
            const content = modal.querySelector('.modal-content');
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            
            header.onmousedown = dragMouseDown;
            
            function dragMouseDown(e) {
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }
            
            function elementDrag(e) {
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                content.style.top = (content.offsetTop - pos2) + "px";
                content.style.left = (content.offsetLeft - pos1) + "px";
                content.style.transform = 'none';
            }
            
            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }
    
        function openGroupModal(groupId) {
            currentGroupId = groupId;
            SESSION_STORAGE_KEY = `serenemind-session-${currentGroupId}`;
            const group = groupsData[groupId];
            const modal = document.getElementById('groupModal');
            
            // Set modal content
            document.getElementById('modalGroupTitle').textContent = group.title;
            document.getElementById('modalDoctorName').textContent = group.doctor;
            document.getElementById('modalDoctorFullName').textContent = group.doctorFull;
            document.getElementById('modalGroupDescription').textContent = group.description;
            document.getElementById('doctorSpecialty').textContent = group.specialty;
            document.getElementById('doctorImage').src = group.doctorImage;
            
            // Reset UI
            document.getElementById('registrationForm').style.display = 'block';
            document.getElementById('sessionInterface').style.display = 'none';
            document.getElementById('groupRegistrationForm').reset();
            
            // Clear previous data
            document.getElementById('groupChat').innerHTML = 
                '<div class="message doctor-message"><strong>Group Facilitator:</strong> Welcome to the group! The session will begin shortly.</div>';
            document.getElementById('videoGrid').innerHTML = '';
            
            // Reset tabs to chat view
            switchTab('chat');
            
            // Generate unique session ID
            sessionId = 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5);
            
            modal.style.display = 'block';
        }
    
        // Close modal
        function closeModal() {
            stopPolling();
            if (localStream) {
                endVideoCall();
            }
            document.getElementById('groupModal').style.display = 'none';
        }
    
        // Check internet connection
        async function checkInternetConnection() {
            try {
                const response = await fetch('https://jsonplaceholder.typicode.com/posts/1', {
                    method: 'HEAD',
                    cache: 'no-cache'
                });
                return response.ok;
            } catch (error) {
                return false;
            }
        }
    
        // Register for group
        async function registerForGroup() {
            const userName = document.getElementById('userName').value;
            const userEmail = document.getElementById('userEmail').value.toLowerCase();
            const anonymous = document.getElementById('anonymousOption').checked;
            
            if (!userName || !userEmail || !document.getElementById('agreeTerms').checked) {
                alert('Please fill in all required fields and agree to the terms.');
                return;
            }
            
            // Check internet connection
            const isOnline = await checkInternetConnection();
            if (!isOnline) {
                alert('You must be connected to the internet to join the session.');
                return;
            }
            
            // Check if user is a doctor by email (case insensitive)
            isDoctor = DOCTOR_EMAILS.includes(userEmail);
            
            // Save user data
            currentUser = {
                id: 'user-' + Math.random().toString(36).substr(2, 9),
                name: userName,
                email: userEmail,
                anonymous: anonymous,
                displayName: anonymous ? 'Anonymous' : userName,
                isDoctor: isDoctor
            };
            
            // Hide registration form and show session interface
            document.getElementById('registrationForm').style.display = 'none';
            document.getElementById('sessionInterface').style.display = 'block';
            
            // Add welcome message
            const chatContainer = document.getElementById('groupChat');
            const welcomeMsg = document.createElement('div');
            welcomeMsg.className = 'message doctor-message';
            welcomeMsg.innerHTML = `<strong>System:</strong> Welcome ${currentUser.displayName}! ${isDoctor ? 
                'You are the session facilitator.' : 'The session will begin when the doctor joins.'}`;
            chatContainer.appendChild(welcomeMsg);
            
            // Show appropriate controls based on role
            if (isDoctor) {
                document.getElementById('doctorControls').style.display = 'block';
                document.getElementById('waitingRoom').style.display = 'none';
                document.getElementById('activeCall').style.display = 'block';
            } else {
                document.getElementById('userPermissionRequest').style.display = 'none';
                updateParticipantCount();
            }
            
            // Initialize video call
            initVideoCall();
            
            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
    
        // Initialize video call with cross-browser support
        function initVideoCall() {
            // Set up polling for cross-browser communication
            startPolling();
            
            if (isDoctor) {
                // For doctors, show the permission request
                document.getElementById('doctorControls').style.display = 'block';
                document.getElementById('waitingRoom').style.display = 'none';
                document.getElementById('activeCall').style.display = 'block';
                
                // Initialize session state
                updateSessionState(SESSION_STATES.WAITING);
            } else {
                // For regular users, check current session state
                checkSessionState();
                updateParticipantCount();
            }
        }
    
        // Start polling for session state changes
        function startPolling() {
            // Clear any existing interval
            if (pollIntervalId) {
                clearInterval(pollIntervalId);
            }
            
            // Start new polling interval
            pollIntervalId = setInterval(checkSessionState, POLL_INTERVAL);
        }
    
        // Stop polling
        function stopPolling() {
            if (pollIntervalId) {
                clearInterval(pollIntervalId);
                pollIntervalId = null;
            }
        }
    
        // Check current session state from storage with timestamp
        function checkSessionState() {
            const sessionData = localStorage.getItem(SESSION_STORAGE_KEY);
            if (!sessionData) return;
            
            try {
                const { state, timestamp, participants: remoteParticipants } = JSON.parse(sessionData);
                
                // Only process if the data is fresh (within last 5 seconds)
                if (Date.now() - timestamp > 5000) return;
                
                if (state === SESSION_STATES.ACTIVE) {
                    if (!isDoctor) {
                        // Session is active - show join button for users
                        document.getElementById('waitingMessage').textContent = 'Session Started!';
                        document.getElementById('waitingDescription').textContent = 'The doctor has started the session. Join now!';
                        document.getElementById('userPermissionRequest').style.display = 'block';
                        
                        // Show waiting participants count
                        if (remoteParticipants) {
                            document.getElementById('participantCount').textContent = 
                                `${remoteParticipants.length} participant${remoteParticipants.length !== 1 ? 's' : ''} in session`;
                        }
                    } else {
                        // For doctor, show active session
                        document.getElementById('waitingRoom').style.display = 'none';
                        document.getElementById('activeCall').style.display = 'block';
                        
                        // Display all participants
                        if (remoteParticipants) {
                            remoteParticipants.forEach(p => displayRemoteParticipant(p));
                        }
                    }
                } else if (state === SESSION_STATES.ENDED) {
                    endVideoCall();
                    document.getElementById('waitingMessage').textContent = 'Session Ended';
                    document.getElementById('waitingDescription').textContent = 'This session has already concluded.';
                    document.getElementById('userPermissionRequest').style.display = 'none';
                }
            } catch (e) {
                console.error('Error parsing session data:', e);
            }
        }
    
        // Update session state in storage with timestamp
        function updateSessionState(state) {
            const sessionData = JSON.stringify({
                state: state,
                timestamp: Date.now(),
                participants: participants.map(p => ({
                    id: p.id,
                    name: p.name,
                    isDoctor: p.isDoctor,
                    muted: p.muted,
                    videoOff: p.videoOff
                }))
            });
            localStorage.setItem(SESSION_STORAGE_KEY, sessionData);
        }
    
        // Display remote participant video
        function displayRemoteParticipant(participant) {
            const videoGrid = document.getElementById('videoGrid');
            
            // Check if participant already exists
            if (document.getElementById(`participant-${participant.id}`)) {
                return;
            }
    
            const participantDiv = document.createElement('div');
            participantDiv.className = `video-participant ${participant.isDoctor ? 'doctor' : ''}`;
            participantDiv.id = `participant-${participant.id}`;
            
            const video = document.createElement('video');
            video.autoplay = true;
            if (participant.stream) {
                video.srcObject = participant.stream;
            }
            
            const infoDiv = document.createElement('div');
            infoDiv.className = 'participant-info';
            infoDiv.innerHTML = `
                <span>${participant.name}</span>
                <div class="participant-status">
                    <i class="fas fa-microphone status-icon ${participant.muted ? 'muted' : ''}"></i>
                    <i class="fas fa-video status-icon ${participant.videoOff ? 'video-off' : ''}"></i>
                </div>
            `;
            
            participantDiv.appendChild(video);
            participantDiv.appendChild(infoDiv);
            videoGrid.appendChild(participantDiv);
        }
    
        // Doctor starts video session
        async function startDoctorVideoSession() {
            try {
                // First check internet connection
                const isOnline = await checkInternetConnection();
                if (!isOnline) {
                    alert('You must be connected to the internet to start the session.');
                    return;
                }
                
                // Get user media
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });
                
                // Create video element
                const localVideo = document.createElement('video');
                localVideo.id = 'localVideo';
                localVideo.autoplay = true;
                localVideo.muted = true;
                localStream.getVideoTracks()[0].enabled = true;
                localVideo.srcObject = localStream;
                
                // Create participant div
                const participantDiv = document.createElement('div');
                participantDiv.className = `video-participant doctor`;
                participantDiv.id = `participant-${currentUser.id}`;
                
                // Add video to participant div
                participantDiv.appendChild(localVideo);
                
                // Create participant info
                const infoDiv = document.createElement('div');
                infoDiv.className = 'participant-info';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = currentUser.displayName;
                
                const statusDiv = document.createElement('div');
                statusDiv.className = 'participant-status';
                
                const micIcon = document.createElement('i');
                micIcon.className = 'fas fa-microphone status-icon';
                
                const videoIcon = document.createElement('i');
                videoIcon.className = 'fas fa-video status-icon';
                
                statusDiv.appendChild(micIcon);
                statusDiv.appendChild(videoIcon);
                infoDiv.appendChild(nameSpan);
                infoDiv.appendChild(statusDiv);
                participantDiv.appendChild(infoDiv);
                
                // Add to video grid
                const videoGrid = document.getElementById('videoGrid');
                videoGrid.appendChild(participantDiv);
                
                // Hide permission request and show session controls
                document.getElementById('permissionRequest').style.display = 'none';
                document.getElementById('doctorSessionControls').style.display = 'block';
                
                // Add current user to participants list
                addParticipant({
                    id: currentUser.id,
                    name: currentUser.displayName,
                    stream: localStream,
                    isDoctor: isDoctor,
                    muted: false,
                    videoOff: false
                });
                
                // Start the session
                startSession();
                
            } catch (error) {
                console.error('Error starting session:', error);
                let errorMessage = 'Could not access camera/microphone.';
                
                if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                    errorMessage += ' No media devices found.';
                } else if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMessage += ' Permission denied.';
                } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                    errorMessage += ' Device is already in use.';
                }
                
                alert(errorMessage);
            }
        }
    
        // User joins video session after doctor starts it
        async function joinUserVideoSession() {
            try {
                // First check internet connection
                const isOnline = await checkInternetConnection();
                if (!isOnline) {
                    alert('You must be connected to the internet to join the session.');
                    return;
                }
                
                // Get user media
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });
                
                // Create video element for local user
                const localVideo = document.createElement('video');
                localVideo.id = 'localVideo';
                localVideo.autoplay = true;
                localVideo.muted = true;
                localStream.getVideoTracks()[0].enabled = true;
                localVideo.srcObject = localStream;
                
                // Create participant div for local user
                const participantDiv = document.createElement('div');
                participantDiv.className = 'video-participant';
                participantDiv.id = `participant-${currentUser.id}`;
                
                // Add video to participant div
                participantDiv.appendChild(localVideo);
                
                // Create participant info
                const infoDiv = document.createElement('div');
                infoDiv.className = 'participant-info';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = currentUser.displayName;
                
                const statusDiv = document.createElement('div');
                statusDiv.className = 'participant-status';
                
                const micIcon = document.createElement('i');
                micIcon.className = 'fas fa-microphone status-icon';
                
                const videoIcon = document.createElement('i');
                videoIcon.className = 'fas fa-video status-icon';
                
                statusDiv.appendChild(micIcon);
                statusDiv.appendChild(videoIcon);
                infoDiv.appendChild(nameSpan);
                infoDiv.appendChild(statusDiv);
                participantDiv.appendChild(infoDiv);
                
                // Add to video grid
                const videoGrid = document.getElementById('videoGrid');
                videoGrid.appendChild(participantDiv);
                
                // Hide permission request
                document.getElementById('userPermissionRequest').style.display = 'none';
                
                // Add current user to participants list
                addParticipant({
                    id: currentUser.id,
                    name: currentUser.displayName,
                    stream: localStream,
                    isDoctor: isDoctor,
                    muted: false,
                    videoOff: false
                });
                
            } catch (error) {
                console.error('Error accessing media devices:', error);
                let errorMessage = 'Could not access camera/microphone.';
                
                if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                    errorMessage += ' No media devices found.';
                } else if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMessage += ' Permission denied.';
                } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                    errorMessage += ' Device is already in use.';
                }
                
                alert(errorMessage);
            }
        }
    
        // Start session (doctor only)
        function startSession() {
            if (!isDoctor) return;
            
            sessionActive = true;
            updateSessionState(SESSION_STATES.ACTIVE);
            
            // Add welcome message to chat
            const chatContainer = document.getElementById('groupChat');
            const welcomeMsg = document.createElement('div');
            welcomeMsg.className = 'message doctor-message';
            welcomeMsg.innerHTML = `<strong>Group Facilitator:</strong> Welcome everyone to today's session. Let's begin by checking in with how everyone is feeling.`;
            chatContainer.appendChild(welcomeMsg);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
    
        // Add participant to call
        function addParticipant(participant) {
            // Check if participant already exists
            const existingIndex = participants.findIndex(p => p.id === participant.id);
            if (existingIndex >= 0) {
                participants[existingIndex] = participant;
            } else {
                participants.push(participant);
            }
            
            // Update UI
            displayRemoteParticipant(participant);
            updateParticipantCount();
            updateSessionState(sessionActive ? SESSION_STATES.ACTIVE : SESSION_STATES.WAITING);
        }
        
        // Update waiting room participant count
        function updateParticipantCount() {
            document.getElementById('participantCount').textContent = 
                `${participants.length} participant${participants.length !== 1 ? 's' : ''} ${sessionActive ? 'in session' : 'waiting (including you)'}`;
        }
        
        // End session for all (doctor only)
        function endSessionForAll() {
            if (!isDoctor) return;
            
            updateSessionState(SESSION_STATES.ENDED);
            alert('Session ended for all participants');
            endVideoCall();
            closeModal();
        }
        
        // Toggle mute for local user
        function toggleMute() {
            if (!localStream) return;
            
            isMuted = !isMuted;
            localStream.getAudioTracks().forEach(track => {
                track.enabled = !isMuted;
            });
            
            // Update UI
            const icon = document.querySelector('.video-btn .fa-microphone');
            if (isMuted) {
                icon.classList.replace('fa-microphone', 'fa-microphone-slash');
            } else {
                icon.classList.replace('fa-microphone-slash', 'fa-microphone');
            }
            
            // Update participant state
            const participant = participants.find(p => p.id === currentUser.id);
            if (participant) {
                participant.muted = isMuted;
                updateSessionState(sessionActive ? SESSION_STATES.ACTIVE : SESSION_STATES.WAITING);
            }
        }
        
        // Toggle video for local user
        function toggleVideo() {
            if (!localStream) return;
            
            isVideoOff = !isVideoOff;
            localStream.getVideoTracks().forEach(track => {
                track.enabled = !isVideoOff;
            });
            
            // Update UI
            const icon = document.querySelector('.video-btn .fa-video');
            if (isVideoOff) {
                icon.classList.replace('fa-video', 'fa-video-slash');
            } else {
                icon.classList.replace('fa-video-slash', 'fa-video');
            }
            
            // Update participant state
            const participant = participants.find(p => p.id === currentUser.id);
            if (participant) {
                participant.videoOff = isVideoOff;
                updateSessionState(sessionActive ? SESSION_STATES.ACTIVE : SESSION_STATES.WAITING);
            }
        }
        
        // End video call
        function endVideoCall() {
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    track.stop();
                    track.enabled = false;
                });
                localStream = null;
            }
            
            // Clear video grid but keep doctor controls if doctor
            if (!isDoctor) {
                document.getElementById('videoGrid').innerHTML = '';
            }
            
            participants = participants.filter(p => p.id === currentUser.id);
            sessionActive = false;
            
            if (isDoctor) {
                updateSessionState(SESSION_STATES.ENDED);
            }
        }
        
        // Send chat message
        function sendMessage() {
            const messageInput = document.getElementById('chatMessage');
            const message = messageInput.value.trim();
            
            if (message) {
                const chatContainer = document.getElementById('groupChat');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message user-message';
                messageDiv.textContent = message;
                chatContainer.appendChild(messageDiv);
                
                // Scroll to bottom
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                // Clear input
                messageInput.value = '';
            }
        }
    </script>
</body>
</html>